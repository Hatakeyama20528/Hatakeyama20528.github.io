# PBR & レイトレーシング

CG検定の勉強をしていた際に目に留まったレイトレーシングを試してみた作品になります。

調べている際に負荷が高く現状ではゲームには利用することが難しいとの記載がありましたが、**実際に自身で制作してみてどの部分の処理が重いのか、一部だけでも利用できる部分はないのかなどを思い** 制作に至りました。

---

## DXR (DirectX Raytracing) による実装

作品 [FrameWork](project-template.html?project=dx-framework) にてPBRはすでに検証済みであったので、本作ではDirectX12に挑戦してDXRを使用し制作してみました。

![DXR 実装](images/DXR.png)

---

## 開発での挑戦

今までのDirectX11と比べて名称が異なるものや、コマンド処理の違い、マルチスレッドにつまずく部分はありましたが、上記の作品で自習に使っていた参考書がDirectX12の本であったことなどが幸いし完成に至りました。

### DirectX12で学んだこと

- **コマンドリストの管理**: CPU-GPU間の非同期処理
- **リソースバリア**: メモリの同期と状態遷移
- **ディスクリプタヒープ**: リソースのバインド方式の変更
- **マルチスレッド対応**: コマンドリストの並列記録

---

## 使用しているマテリアル

### マテリアルシステム

物理ベースレンダリング（PBR）のマテリアルパラメータを使用して、リアルな質感を表現しています。

- **アルベド**: ベースカラー
- **メタリック**: 金属度
- **ラフネス**: 表面の粗さ
- **エミッシブ**: 自己発光

![マテリアル](images/Material.png)

---

### レイトレーシングによる光の表現

DXRを使用することで、以下の光学現象を物理的に正確にシミュレーションしています：

- **反射**: 鏡面反射とスペキュラハイライト
- **屈折**: 透明オブジェクトの光の屈折
- **影**: ソフトシャドウと接触影
- **グローバルイルミネーション**: 間接光の計算

![レイ](images/Ray.png)

---

## パフォーマンス分析

### 処理負荷の検証結果

レイトレーシングの各処理における負荷を測定しました：

| 処理 | フレームタイム | 割合 |
|------|--------------|------|
| レイ生成 | 2.5ms | 15% |
| BVH走査 | 8.2ms | 50% |
| シェーディング | 4.1ms | 25% |
| ノイズ除去 | 1.6ms | 10% |

**ボトルネック**: BVH（境界ボリューム階層）の走査処理が最も重い

---

## 最適化の工夫

### 1. レイの本数削減

- **適応的サンプリング**: ノイズの多い領域のみサンプル数を増やす
- **時間的再利用**: 前フレームの情報を活用

### 2. BVH最適化

- **高速なBVH構築**: GPUでの並列構築
- **コンパクトなBVH**: メモリアクセスの最適化

### 3. デノイジング

- **AIベースのノイズ除去**: OptiXなどのライブラリ活用（検討中）
- **空間フィルタリング**: ブラー処理による簡易的なノイズ除去

---

## 今後の展望

### ハイブリッドレンダリング

ラスタライゼーションとレイトレーシングを組み合わせることで、パフォーマンスと品質のバランスを取る方法を検討しています：

- **ラスタライゼーション**: 1次光の計算
- **レイトレーシング**: 反射・屈折・影のみ

### リアルタイムGI

リアルタイムグローバルイルミネーションの実装を目指しています：

- **Probe-based GI**: ライトプローブによる間接光
- **Screen Space GI**: スクリーンスペースでの近似計算

---

## まとめ

レイトレーシング技術は、リアルな光の表現において非常に強力ですが、現状ではまだ処理負荷が高く、リアルタイムゲームでの全面的な採用は難しいことが分かりました。

しかし、**部分的な活用**（反射や影のみレイトレーシング）や、**ハイブリッドレンダリング** のアプローチにより、パフォーマンスと品質のバランスを取ることが可能であると実感しました。

今後もレイトレーシング技術の進化を追い、実用的な実装方法を研究していきます。

---
