# DirectX フレームワーク

今年の進級制作展（就活）作品を制作するためのフレームワークとして準備している作品になります。

描画まわりについてこだわりたいと思っているので、実現できるように**ディファードレンダリング**、**頂点圧縮**、を実装しています。

## プロジェクト概要

本フレームワークは、次世代のゲームエンジン技術を目指して、以下の先進的な機能を実装しています：

- **カスタムレンダリングパイプライン**: 拡張可能なレンダーパスシステム
- **物理演算エンジン統合**: Jolt Physicsによる高性能物理シミュレーション
- **仮想ジオメトリシステム**: 次世代レンダリング技術の実装（開発中）
- **最適化された頂点データ管理**: メモリ効率を重視したデータ構造

---

## レンダリングパイプライン

### カスタムレンダーパスアーキテクチャ

本フレームワークでは、**拡張可能なレンダーパスシステム**を採用しています。各レンダリングステージを独立したパスとして実装することで、柔軟な描画処理を実現しています。

![レンダーパス構造](images/RenderPassArchitecture.png)

#### レンダーパスの種類

1. **ClearRenderPass** - レンダーターゲットのクリア
2. **OpaqueRenderPass** - 不透明オブジェクトの描画
3. **SkyboxRenderPass** - スカイボックスの描画
4. **TransparentRenderPass** - 半透明オブジェクトの描画
5. **PostProcessRenderPass** - ポストプロセス効果

各パスは`RenderPassEvent`で実行タイミングを制御し、前処理・後処理を柔軟に挿入できます。

```cpp
enum class RenderPassEvent {
    BeforeRendering,
    BeforeRenderingOpaques,
    AfterRenderingOpaques,
    BeforeRenderingSkybox,
    AfterRenderingSkybox,
    BeforeRenderingTransparents,
    AfterRenderingTransparents,
    BeforeRenderingPostProcessing,
    AfterRenderingPostProcessing,
    AfterRendering
};
```

### ディファードレンダリング

**Gバッファ**を用いたディファードレンダリングを実装し、複数のライティング処理を効率化しています。

**Gバッファの構成：**
- **RT0**: アルベド（RGB）+ メタリック（A）
- **RT1**: 法線（RGB）+ ラフネス（A）
- **RT2**: 深度 + ワールド座標
- **RT3**: エミッシブ + AO

![Gバッファ構造](images/GBuffer.png)

---

## 圧縮プログラムのダウンロード

頂点圧縮のサンプルプログラムは下記よりダウンロードできます：

[Google Drive（圧縮プログラム配布）](https://drive.google.com/drive/folders/1KpQY3D3uRsKXaaPuWcbWdjbdqgczFl_o?usp=drive_link)

## 頂点圧縮について

下記の画像で使用しているモデルの頂点数は 9036個、一個当たり38バイトで合計約335.3KBとなります。

圧縮後の頂点は一個当たり20バイトで合計約176.4KBまで圧縮できています。

**圧縮率: 約47%のメモリ削減を達成**

![頂点圧縮モデル](images/ConpModel.png)

## 頂点のレイアウトについて

最適化された頂点レイアウトを採用し、GPUキャッシュヒット率の向上を図っています。

![頂点レイアウト](images/Layout.png)

## 圧縮方式について

法線についてはOctahedronEncoding（[参考サイト](https://knarkowicz.wordpress.com/2014/04/16/octahedron-normal-vector-encoding/)）を使用しており、もとの12バイトから4バイトまで圧縮を成功しています。

**圧縮アルゴリズムの特徴：**
- Float3（12バイト）→ UInt16x2（4バイト）
- 精度の損失を最小限に抑制
- デコード処理の高速化

![圧縮方式1](images/Normal1.png)
![圧縮方式2](images/Normal2.png)

---

## 物理演算システム

### Jolt Physics統合

本フレームワークでは、**Jolt Physics**エンジンを統合し、高性能な物理シミュレーションを実現しています。

**主な機能：**
- **リジッドボディシミュレーション**: 動的・静的・キネマティックオブジェクトのサポート
- **衝突検出**: BroadPhaseとNarrowPhaseの最適化
- **制約システム**: ヒンジ、スライダー、固定ジョイントなど
- **キャラクターコントローラー**: ゲームキャラクター向けの専用物理制御

![物理演算システム](images/PhysicsIntegration.png)

### 物理コンポーネントアーキテクチャ

エンティティコンポーネントシステム（ECS）パターンを採用し、ゲームオブジェクトに物理挙動を柔軟に追加できます。

```cpp
// RigidBodyコンポーネントの例
class RigidBodyComponent {
    JPH::BodyID bodyID;
    float mass;
    Vec3 centerOfMass;
    EMotionType motionType; // Static, Kinematic, Dynamic
};
```

---

## 画像処理について

**コンピュートシェーダー**を活用した高度な画像処理を実装しています。

**実装済みフィルター：**
- **ガウシアンフィルタ**: ブラー効果
- **ソーベルフィルタ**: エッジ検出
- **シンプレックスノイズ**: プロシージャルテクスチャ生成

![画像処理テスト](images/TextureTest.png)

---

## シェーダーについて

### 1. 法線デコード処理

頂点圧縮で格納した法線ベクトルをデコードするシェーダーコード例です。16bit整数から-1～1の範囲に変換し、八面体マッピングで復元しています。

![法線デコードシェーダー](images/Decode.png)

### 2. ディファードレンダリング用Gバッファ書き出し

Gバッファへの書き出しを行うピクセルシェーダーの一部です。アルベド、深度、法線、マテリアル情報をそれぞれのターゲットに出力しています。

![Gバッファ書き出しシェーダー](images/GBuff.png)

### 3. こだわったマテリアル表現

**PBR（物理ベースレンダリング）**を意識し作成しました、追加でアウトラインを表示しています。

**実装した技術：**
- **Cook-Torranceモデル**: マイクロファセット理論に基づくBRDF
- **GGX分布**: より現実的なスペキュラハイライト
- **フレネル反射**: Schlick近似による高速計算
- **背面法によるアウトライン**: セルシェーディング風の表現

簡易実装として使用した方法は背面法で、現在ソーベルフィルタを使った輪郭検出を作成しています。

![マテリアルシェーダー1](images/PBR_PS.png)
![マテリアルシェーダー2](images/PBR_Render.png)
![追加マテリアル画像](images/NewMaterial.png)

---

## 雨粒のポストプロセス

**開発中**

パーティクルシステムと組み合わせた、動的な雨粒エフェクトを実装予定です。

---

## 仮想ジオメトリシステム（開発中）

次世代のレンダリング技術として、**仮想ジオメトリシステム**の実装を進めています。

**目標：**
- 数百万ポリゴンのシームレスな描画
- 自動LOD管理
- メモリ効率の最適化

詳細は [仮想ジオメトリページ](project-template.html?project=virtual-geometry) をご覧ください。

---

## 今後の開発予定

- ディファードレンダリング
- 頂点圧縮
- 物理演算統合
- PBRマテリアル
- 仮想ジオメトリシステム
- 動的グローバルイルミネーション
- ボリュメトリックライティング
- レイトレーシング対応（DirectX12 DXR）
